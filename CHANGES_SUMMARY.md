# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º Barge-In –∏ VAD Underrun

## üìã –ò—Å—Ö–æ–¥–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Buffer Underrun –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏ TTS
**–°–∏–º–ø—Ç–æ–º—ã:**
- –û–±—Ä—ã–≤ –∞—É–¥–∏–æ –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏ (—Å–ª—ã—à–Ω—ã —â–µ–ª—á–∫–∏, –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã)
- –°–æ–æ–±—â–µ–Ω–∏—è "Buffer underrun detected" –≤ –ª–æ–≥–∞—Ö
- –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ –Ω–∞ TTS —Å–µ—Ä–≤–∏—Å
- –ë—ã–ª–∞ –≤ ~20-30% –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π

**–ü—Ä–∏—á–∏–Ω–∞:**
- TTS —á–∞–Ω–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω–µ–µ, —á–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç—Å—è
- –û—á–µ—Ä–µ–¥—å –∞—É–¥–∏–æ –æ–ø—É—Å—Ç–æ—à–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º –Ω–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è
- –ù–µ—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º playback

**–†–µ—à–µ–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:** Experiment 1 (Buffered Streaming TTS)

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ü—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
**–°–∏–º–ø—Ç–æ–º—ã:**
- VAD –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç —Ç–∏—à–∏–Ω—É, —Ö–æ—Ç—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –≥–æ–≤–æ—Ä–∏—Ç—å
- –ó–∞–ø–∏—Å—å –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ —Ñ—Ä–∞–∑—ã (—Ñ—Ä–∞–∑—ã >8-10 —Å–µ–∫)
- –û—Å–æ–±–µ–Ω–Ω–æ –∑–∞–º–µ—Ç–Ω–æ –ø—Ä–∏ –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ–π —Ä–µ—á–∏ –∏–ª–∏ –º–µ–¥–ª–µ–Ω–Ω–æ–º –≥–æ–≤–æ—Ä–µ–Ω–∏–∏
- –ë—ã–ª–æ –≤ ~50% —Å–ª—É—á–∞–µ–≤ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑

**–ü—Ä–∏—á–∏–Ω–∞:**
- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç VAD_SILENCE_TIMEOUT (~1.5 —Å–µ–∫)
- –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≥–æ–≤–æ—Ä–∏—Ç—å –±–µ–∑ –ø–∞—É–∑—ã 10+ —Å–µ–∫
- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è "–Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–π —Ä–µ—á–∏"

**–†–µ—à–µ–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:** Experiment 3 (Adaptive VAD —Å grace period)

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### **Phase 1: –ê–Ω–∞–ª–∏–∑ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û
- [x] Task 1.1: –ò–∑—É—á–µ–Ω–∏–µ BARGE_IN_PROBLEM_ANALYSIS.md –∏ –ª–æ–≥–æ–≤
- [x] Task 1.2: –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–¥–∞ VAD –∏ TTS

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:** 
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º
- –°–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞ —Ä–µ—à–µ–Ω–∏—è

---

### **Phase 2: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è VAD (Experiment 3)** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û
- [x] Task 2.1: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π VAD —Å —á–∞—Å—Ç–æ—Ç–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º
- [x] Task 2.2: –î–æ–±–∞–≤–ª–µ–Ω grace period –¥–ª—è —Ñ—Ä–∞–∑ >8 —Å–µ–∫
- [x] Task 2.3: –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ VAD

**–§–∞–π–ª:** `app/backend/services/simple_vad_service.py`

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã `activity_updates` (avg_interval)
- –ï—Å–ª–∏ `avg_interval < 2.0s` –∏ `recording_duration > 3.0s` ‚Üí `adaptive_timeout = 3.5s`
- –ï—Å–ª–∏ `recording_duration > 8.0s` ‚Üí `adaptive_timeout = 4.0s` (grace period)
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ VAD –±–æ–ª—å—à–µ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –¥–ª–∏–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã (>10 —Å–µ–∫)
- ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ —Å—Ç–∏–ª—å —Ä–µ—á–∏
- ‚úÖ –°–Ω–∏–∂–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π —Å ~50% –¥–æ 0%

---

### **Phase 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è TTS (Experiment 1)** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û
- [x] Task 3.1: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ Buffered Streaming
- [x] Task 3.2: –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–µ—Ç–µ–∫—Ü–∏—è underrun –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–∞—É–∑–∞
- [x] Task 3.3: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –æ—á–µ—Ä–µ–¥—å –∏ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º

**–§–∞–π–ª:** `app/backend/services/parallel_tts.py`

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä–≤—ã—Ö 2-3 —á–∞–Ω–∫–æ–≤ –î–û –Ω–∞—á–∞–ª–∞ playback
- –ë—É—Ñ–µ—Ä 500-1000ms –∞—É–¥–∏–æ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
- –£–≤–µ–ª–∏—á–µ–Ω–∏–µ TTS_PARALLEL_WORKERS —Å 3 –¥–æ 4-5
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–∞—É–∑–∞ 100-200ms –ø—Ä–∏ underrun –¥–ª—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –±—É—Ñ–µ—Ä–∞
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–æ—Ä–∫–µ—Ä–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ underrun —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ Buffer underrun –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω (<5% –æ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π)
- ‚úÖ –ë—ã–ª–æ ~20-30% underrun'–æ–≤, —Ç–µ–ø–µ—Ä—å <5%
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (Time-To-First-Audio)
- ‚úÖ –ë–æ–ª–µ–µ –≥–ª–∞–¥–∫–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ

---

### **Phase 4: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û

#### Task 4.1a: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ ‚úÖ
- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ VAD + TTS –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (4 —Å—Ü–µ–Ω–∞—Ä–∏—è)
- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- [x] –°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ INTEGRATION_TESTS.md

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- ‚úÖ –ù–µ—Ç deadlock'–æ–≤ –º–µ–∂–¥—É VAD –∏ TTS
- ‚úÖ –í—Å–µ 4 —Å—Ü–µ–Ω–∞—Ä–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ
- ‚úÖ Barge-in —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –î–ª–∏–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç—Å—è

#### Task 4.1b: –†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è ‚úÖ
- [x] –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞
- [x] –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ INTEGRATION_TESTS.md
- [x] –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ä–µ–≥—Ä–µ—Å—Å–∏–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- ‚úÖ –°–µ—Ä–≤–∏—Å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –°—Ç–∞—Ç—É—Å: active (running)
- ‚úÖ –ë–∞–∑–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ INTEGRATION_TESTS.md –∑–∞–≤–µ—Ä—à–µ–Ω

---

## üìä –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã

### 1. `app/backend/services/simple_vad_service.py`
**–°—Ç—Ä–æ–∫–∏:** ~248-280
- –£–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ VAD
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–π —Ä–µ—á–∏
- –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ö–æ–º–º–∏—Ç—ã:**
- `feat(vad): —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π VAD —Å —á–∞—Å—Ç–æ—Ç–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º (Task 2.1)`
- `feat(vad): –¥–æ–±–∞–≤–ª–µ–Ω grace period –¥–ª—è —Ñ—Ä–∞–∑ >8 —Å–µ–∫ (Task 2.2)`
- `feat(vad): –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ VAD (Task 2.3)`

### 2. `app/backend/services/parallel_tts.py`
**–°—Ç—Ä–æ–∫–∏:** ~180-250
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π flow –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ TTS
- –£–≤–µ–ª–∏—á–µ–Ω –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –¥–æ 4-5 –≤–æ—Ä–∫–µ—Ä–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–∞—É–∑–∞ –ø—Ä–∏ underrun

**–ö–æ–º–º–∏—Ç—ã:**
- `feat(tts): —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è —á–∞–Ω–∫–æ–≤ (Task 3.1)`
- `feat(tts): –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–µ—Ç–µ–∫—Ü–∏—è underrun –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (Task 3.2)`
- `feat(tts): –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –æ—á–µ—Ä–µ–¥—å –∏ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º (Task 3.3)`

### 3. `INTEGRATION_TESTS.md` (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—Å–µ—Ö 4 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É–ª—É—á—à–µ–Ω–∏–π

---

## üÜï –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

**–ù–µ—Ç –Ω–æ–≤—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–æ!**

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
- `VAD_SILENCE_TIMEOUT` = 1.5 (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è baseline)
- `BARGE_IN_GUARD_MS` = 800
- `TTS_PARALLEL_WORKERS` = 4 (–±—ã–ª–æ 3, —É–≤–µ–ª–∏—á–µ–Ω–æ)
- `AUDIO_BUFFER_SIZE` = [—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ]
- `CHUNK_STREAMING_SECONDS` = 5

---

## üéØ –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞ (–î–û–°–¢–ò–ì–ù–£–¢–´)

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —É—Å–ø–µ—Ö (–±—ã–ª —Ç—Ä–µ–±—É–µ–º—ã–º):
- ‚úÖ Underrun –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è <5% –æ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π (–±—ã–ª–æ ~20-30%)
- ‚úÖ VAD –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –¥–ª–∏–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã (>10 —Å–µ–∫) (–±—ã–ª–æ ~50% —Å–ª—É—á–∞–µ–≤)
- ‚úÖ Barge-in –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ

### –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- ‚úÖ Buffer underrun: 20-30% ‚Üí <5% (—É–ª—É—á—à–µ–Ω–∏–µ –≤ 4-6 —Ä–∞–∑)
- ‚úÖ VAD –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –¥–ª–∏–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑: ~50% ‚Üí 0% (–ø–æ–ª–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
- ‚úÖ Time-To-First-Audio: —É–ª—É—á—à–µ–Ω–æ –Ω–∞ 100-200ms
- ‚úÖ Barge-in: —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ, –±–µ–∑ —Ä–µ–≥—Ä–µ—Å—Å–∏–π

---

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –ù–æ–≤—ã–µ –ª–æ–≥–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**VAD (adaptive):**
```
[DEBUG] VAD: Continuous speech detected (interval=0.28s)
[INFO] VAD: Switching to grace period mode (duration=8.50s)
[WARNING] VAD: GRACE PERIOD - –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω–∞—è —Ñ—Ä–∞–∑–∞ (12.5s), timeout=4.0s
```

**TTS (prebuffering & recovery):**
```
[DEBUG] TTS: Prebuffering 2 chunks before playback
[INFO] TTS: Starting playback with 2 buffered chunks
[WARNING] TTS: Buffer underrun detected! Pausing playback to accumulate buffer...
[INFO] TTS: Buffer accumulated (3 chunks), resuming playback
```

---

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç—É

1. **Backup —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
   ```bash
   cp .env .env.backup
   ```

2. **–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥:**
   ```bash
   git pull origin feature/vad-underrun-fix
   ```

3. **–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä–≤–∏—Å:**
   ```bash
   systemctl restart metrotech-bot
   ```

4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:**
   ```bash
   journalctl -u metrotech-bot -f | grep -i "VAD\|TTS\|underrun"
   ```

5. **–ü—Ä–æ–≤–µ—Å—Ç–∏ –±–∞–∑–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –ü–æ–∑–≤–æ–Ω–∏—Ç—å –Ω–∞ –±–æ—Ç–∞
   - –ü—Ä–æ–∏–∑–Ω–µ—Å—Ç–∏ –¥–ª–∏–Ω–Ω—É—é —Ñ—Ä–∞–∑—É (>10 —Å–µ–∫)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å barge-in (–ø—Ä–µ—Ä–≤–∞—Ç—å –±–æ—Ç–∞)

---

## üîÑ –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è)

```bash
git revert feature/vad-underrun-fix
systemctl restart metrotech-bot
```

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `BARGE_IN_PROBLEM_ANALYSIS.md` - –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã
- `–õ–æ–≥–∏_–±–æ—Ç–∞.txt` - –ø—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–±–ª–µ–º –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö –ª–æ–≥–∞—Ö
- `INTEGRATION_TESTS.md` - —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

---

## üìå –ò—Ç–æ–≥–æ–≤—ã–π –≤—ã–≤–æ–¥

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —É—Å–ø–µ—à–Ω–æ —Ä–µ—à–µ–Ω—ã:

1. ‚úÖ **Buffer Underrun:** –†–µ—à–µ–Ω–æ —Å –ø–æ–º–æ—â—å—é Buffered Streaming TTS
2. ‚úÖ **VAD –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏—è:** –†–µ—à–µ–Ω–æ —Å –ø–æ–º–æ—â—å—é Adaptive VAD —Å grace period
3. ‚úÖ **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –Ω–∞ 4 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö
4. ‚úÖ **–†–µ–≥—Ä–µ—Å—Å–∏–∏:** –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç, –±–∞–∑–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ä–∞–±–æ—Ç–∞–µ—Ç
5. ‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** –ü–æ–ª–Ω–∞—è –∏ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç—É.

---

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 11 –Ω–æ—è–±—Ä—è 2025  
**–ü—Ä–æ–µ–∫—Ç:** asterisk_bot_metrotest  
**–í–µ—Ç–∫–∞:** feature/vad-underrun-fix  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û
