---

# A. –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ –º–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è (—á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å)

1. **–ë–æ—Ç ‚Äú–æ–±—Ä—ã–≤–∞–µ—Ç‚Äù –º–æ—é —Ä–µ—á—å** –¥–∞–∂–µ –±–µ–∑ –ø–∞—É–∑: —è –≥–æ–≤–æ—Ä—é –¥–ª–∏–Ω–Ω–æ –∏ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ, –∞ –∑–∞–ø–∏—Å—å –ø—Ä–µ–∫—Ä–∞—â–∞–µ—Ç—Å—è –∏ —É—Ö–æ–¥–∏—Ç –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ.
2. **Barge-in –≤—Å—Ç—Ä–æ–µ–Ω, –Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**: –ø–æ–ø—ã—Ç–∫–∏ –≤–∫–ª—é—á–∏—Ç—å –ø—Ä–∏–≤–æ–¥–∏–ª–∏ –∫ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω—É (—Å—Ç–∞—Ä—ã–µ TTS-–ø–æ—Ç–æ–∫–∏ –Ω–µ –≥–ª—É—à–∞—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, –æ—Ç–≤–µ—Ç ‚Äú–Ω–∞–ª–µ–∑–∞–µ—Ç‚Äù).
3. (–†–∞–Ω–µ–µ) **–§–∏–ª–ª–µ—Ä—ã –≤–∏–¥–Ω–æ –≤ –ª–æ–≥–∞—Ö, –Ω–æ –Ω–µ —Å–ª—ã—à–Ω–æ** ‚Äî —Ä–µ—à–µ–Ω–æ –ø–æ–∑–∂–µ; —Å–µ–π—á–∞—Å –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç.
4. (–†–∞–Ω–µ–µ) **–ò–Ω–æ–≥–¥–∞ –≤—ã–∑–æ–≤ ‚Äú—Å–∞–º‚Äù –∑–∞–≤–µ—Ä—à–∞–ª—Å—è** ‚Äî —É –∫–æ–¥–∞ –±—ã–ª –∂—ë—Å—Ç–∫–∏–π —Ç–∞–π–º–∞—É—Ç –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è; –Ω—É–∂–Ω–æ –≤—ã–Ω–æ—Å–∏—Ç—å –≤ `.env`.

–¶–µ–ª—å: **–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç–≤–µ—Ç–∞ –∏ –ø—Ä–∏ —ç—Ç–æ–º –±–æ—Ç –¥–æ–ª–∂–µ–Ω –¥–æ—Å–ª—É—à–∏–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**; barge-in ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –∏ –±–µ–∑ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∞.

---

# B. –ö–∞—Ä—Ç–∏–Ω–∞ —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (–≤–∞–∂–Ω–æ –¥–ª—è –∞–≥–µ–Ω—Ç–∞)

* **–ò—Å—Ö–æ–¥—è—â–∏–π –≥–æ–ª–æ—Å (–±–æ—Ç ‚Üí –∞–±–æ–Ω–µ–Ω—Ç)**: —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω **chunked TTS** + –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—å (`parallel_tts.py`).
* **–í—Ö–æ–¥—è—â–∏–π –≥–æ–ª–æ—Å (–∞–±–æ–Ω–µ–Ω—Ç ‚Üí –±–æ—Ç)**: –ø–æ–∫–∞ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π **VAD‚ÜíWAV‚ÜíASR**: –∑–∞–ø–∏—Å—å *–æ–¥–Ω–∏–º —Ñ–∞–π–ª–æ–º* –¥–æ —Ç–∏—à–∏–Ω—ã –∏–ª–∏ –¥–æ –ª–∏–º–∏—Ç–∞ `VAD_MAX_RECORDING_TIME`, –∑–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ ASR. **–°—Ç—Ä–∏–º–∏–Ω–≥–∞/—á–∞–Ω–∫–æ–≤–∞–Ω–∏—è –≤—Ö–æ–¥—è—â–µ–π —Ä–µ—á–∏ –Ω–µ—Ç.** –≠—Ç–æ –∏ ‚Äú—Ä–µ–∂–µ—Ç‚Äù –¥–ª–∏–Ω–Ω—ã–µ –º–æ–Ω–æ–ª–æ–≥–∏.
* **Barge-in**: –ª–æ–≥–∏–∫–∞ –≤—ã–∑–æ–≤–∞ –µ—Å—Ç—å (–æ—á–∏—Å—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–µ–π), –Ω–æ **–Ω–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≥–∞—à–µ–Ω–∏—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö ARI-playbacks** —É Asterisk.

---

# C. –ü–ª–∞–Ω —Ä–∞–±–æ—Ç (—Ç–∞—Å–∫-–ª–∏—Å—Ç –¥–ª—è Cursor-–∞–≥–µ–Ω—Ç–∞)

1. **[–í–•–û–î] –î–æ–±–∞–≤–∏—Ç—å ‚Äú–º—è–≥–∫–æ–µ –æ–∫–Ω–æ‚Äù –¥–ª—è –∑–∞–ø–∏—Å–∏ —Ä–µ—á–∏ –∫—É—Å–∫–∞–º–∏ –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–ø–∏—Å–∏** (–∫–≤–∞–∑–∏—Å—Ç—Ä–∏–º):

   * `simple_vad_service.py`: –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `record_until_silence_with_soft_window(...)`.
   * `stasis_handler_optimized.py`: –æ–±—Ä–∞–±–æ—Ç–∫–∞ `on_chunk`, –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–µ—Ñ–µ—Ç—á.

2. **[–í–•–û–î] –û—Å–ª–∞–±–∏—Ç—å –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–±—Ä—ã–≤—ã –∑–∞–ø–∏—Å–∏**:

   * `.env`: –ø–æ–¥–Ω—è—Ç—å `VAD_MAX_RECORDING_TIME` (12‚Äì15s), `VAD_SILENCE_TIMEOUT=2.0`, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å `SPEECH_SILENCE_TIMEOUT=2.0`, `SPEECH_MIN_DURATION=0.6‚Äì0.8`.

3. **[–í–´–•–û–î] –ü–æ—á–∏–Ω–∏—Ç—å barge-in –Ω–∞ —É—Ä–æ–≤–Ω–µ ARI**:

   * `ari_client.py`: –º–µ—Ç–æ–¥ `stop_playback(playback_id)` (DELETE /playbacks/{id}).
   * `stasis_handler_optimized.py`: –≤ `stop_tts_on_barge_in_optimized(...)` ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å *–≤—Å–µ* –∞–∫—Ç–∏–≤–Ω—ã–µ playbacks (–ø–æ —Ä–µ–µ—Å—Ç—Ä—É), —Å—á–∏—Ç–∞—Ç—å `404/409` —É—Å–ø–µ—Ö–æ–º.

4. **[–ñ–ò–ó–ù–ï–ù–ù–´–ô –¶–ò–ö–õ –ó–í–û–ù–ö–ê] –í—ã–Ω–µ—Å—Ç–∏ —Ç–∞–π–º–∞—É—Ç—ã –≤ .env**:

   * `CALL_INACTIVITY_TIMEOUT`, `CHANNEL_MONITOR_INTERVAL` ‚Äî –∑–∞–º–µ–Ω–∏—Ç—å ‚Äú–º–∞–≥–∏—á–µ—Å–∫–∏–µ 30s‚Äù.

5. **(–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) Prefetch** –æ—Ç–≤–µ—Ç–∞ –ø–æ —á–∞—Å—Ç–∏—á–Ω—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º:

   * –í `_handle_user_speech` –Ω–∞—á–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∫ –∞–≥–µ–Ω—Ç—É –ø–æ—Å–ª–µ 1‚Äì2 –∫—É—Å–æ—á–∫–æ–≤, —á—Ç–æ–±—ã —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –ø–∞—É–∑—É.

6. **(–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) Asterisk-—Ç—é–Ω–∏–Ω–≥ –¥–ª—è –Ω–∏–∑–∫–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏**:

   * `rtp.conf`: –æ—Ç–∫–ª—é—á–∏—Ç—å –ª–∏—à–Ω–∏–π –¥–∂–∏—Ç—Ç–µ—Ä-–±—É—Ñ–µ—Ä –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Asterisk, —Ç.–ø.
   * –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ –∫–∞–Ω–∞–ª, –Ω–µ —á–µ—Ä–µ–∑ bridge (–µ—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ ‚Äî —á–µ—Ä–µ–∑ bridge), –∏–ª–∏ –ø—Ä–∏ –±–∞—Ä–¥–∂-–∏–Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å bridge.

---

# D. –ì–æ—Ç–æ–≤—ã–µ –ø—Ä–∞–≤–∫–∏ (–∫–æ–¥, –±–µ–∑ –∑–∞–≥–ª—É—à–µ–∫)

## D1) `.env` ‚Äî –Ω–æ–≤—ã–µ –∏ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

```env
# --- VAD / SmartDetector: —Å–ª—É—Ö –∞–±–æ–Ω–µ–Ω—Ç–∞ ---
VAD_SILENCE_TIMEOUT=2.0          # –±—ã–ª–æ 1.2
VAD_MIN_RECORDING_TIME=1.0       # –±—ã–ª–æ 1.5
VAD_MAX_RECORDING_TIME=15.0      # –±—ã–ª–æ 6.0 (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –æ–±—â–∏–π –ø—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å)
SPEECH_SILENCE_TIMEOUT=2.0       # –±—ã–ª–æ 1.2
SPEECH_MIN_DURATION=0.6          # 0.6‚Äì0.8 –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ
INPUT_DEBOUNCE_MS=1000           # –±—ã–ª–æ 1200 (—Å—É–±—ä–µ–∫—Ç–∏–≤–Ω–æ –∂–∏–≤–µ–µ)
BARGE_IN_GUARD_MS=300            # –±—ã–ª–æ 400 (–ø–µ—Ä–µ–±–∏—Ç—å –±–æ—Ç–∞ —á—É—Ç—å –ª–µ–≥—á–µ)

# --- ‚Äú–ú—è–≥–∫–æ–µ –æ–∫–Ω–æ‚Äù –¥–ª—è –¥–ª–∏–Ω–Ω–æ–π —Ä–µ—á–∏ ---
CHUNK_STREAMING_SECONDS=5
CHUNK_OVERLAP_MS=150
MAX_UTTERANCE_SECONDS=60         # –æ–±—â–∏–π –ø—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å –≤—Å–µ–π —Ä–µ–ø–ª–∏–∫–∏

# --- –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∑–≤–æ–Ω–∫–∞ ---
CALL_INACTIVITY_TIMEOUT=180      # –≤–º–µ—Å—Ç–æ –∑–∞—à–∏—Ç—ã—Ö 30 —Å–µ–∫—É–Ω–¥
CHANNEL_MONITOR_INTERVAL=60
```

> –ï—Å–ª–∏ —Ä–∞–Ω—å—à–µ –±—ã–ª –¥—É–±–ª–∏–∫–∞—Ç `SPEECH_MAX_RECORDING_TIME=8.0` ‚Äî —É–¥–∞–ª–∏—Ç—å, —á—Ç–æ–±—ã –∫–æ–¥ –Ω–µ –±—Ä–∞–ª ‚Äú–∫–æ—Ä–æ—Ç–∫–∏–π‚Äù –ª–∏–º–∏—Ç.

---

## D2) `simple_vad_service.py` ‚Äî ‚Äú–∫–≤–∞–∑–∏—Å—Ç—Ä–∏–º‚Äù: –∑–∞–ø–∏—Å—å –∫—É—Å–∫–∞–º–∏ –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

–î–æ–±–∞–≤—å—Ç–µ **–Ω–æ–≤—ã–π** –º–µ—Ç–æ–¥ (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–µ –ª–æ–º–∞–µ–º):

```python
# simple_vad_service.py
import os, wave, time
from time import monotonic

class SimpleVADService:
    def __init__(self, logger, ...):
        self.logger = logger
        self.silence_timeout = float(os.getenv("VAD_SILENCE_TIMEOUT", "2.0"))
        self.min_rec_time    = float(os.getenv("VAD_MIN_RECORDING_TIME", "1.0"))
        # –ü—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å –≤—Å–µ–π —Ä–µ–ø–ª–∏–∫–∏:
        self.max_utt_time    = float(os.getenv("MAX_UTTERANCE_SECONDS", "60.0"))
        # ‚Äú–ú—è–≥–∫–æ–µ –æ–∫–Ω–æ‚Äù (–¥–ª–∏–Ω–∞ –æ–¥–Ω–æ–≥–æ –∫—É—Å–∫–∞):
        self.chunk_secs      = float(os.getenv("CHUNK_STREAMING_SECONDS", "5"))
        self.chunk_overlap   = int(os.getenv("CHUNK_OVERLAP_MS", "150"))

    async def record_until_silence_with_soft_window(self, channel_id: str, on_chunk):
        """
        –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –¥–ª–∏–Ω–Ω—É—é —Ä–µ—á—å –∫—É—Å–∫–∞–º–∏, –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—è –∑–∞–ø–∏—Å—å:
        - on_chunk(path, is_final, index): —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ/–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç WAV –≤ ASR
        - is_final=True –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–π —Ç–∏—à–∏–Ω–µ –∏–ª–∏ –ø—Ä–∏ max_utt_time
        """
        start_ts   = monotonic()
        index      = 0
        last_voice = monotonic()
        deadline   = monotonic() + self.chunk_secs

        wav = self._start_new_wav(channel_id, index)

        while True:
            frame = await self._read_audio_frame()  # –≤–∞—à –∏—Å—Ç–æ—á–Ω–∏–∫ PCM (20‚Äì30–º—Å)
            if frame is None:
                break

            self._write_pcm(wav, frame)
            now = monotonic()

            if self._is_speech(frame):
                last_voice = now

            # 1) –¢–∏—à–∏–Ω–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ‚Üí —Ñ–∏–Ω–∞–ª –≤—Å–µ–π —Ä–µ–ø–ª–∏–∫–∏
            if (now - last_voice) >= self.silence_timeout and (now - start_ts) >= self.min_rec_time:
                path = self._finalize_wav(wav)
                try:
                    await on_chunk(path, True, index)   # final
                finally:
                    self._close(wav)
                return

            # 2) –ò—Å—Ç—ë–∫ ‚Äú–∫—É—Å–æ–∫ –æ–∫–Ω–∞‚Äù ‚Üí –∑–∞–∫—Ä—ã–≤–∞–µ–º partial –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–ø–∏—Å—å
            if now >= deadline:
                path = self._finalize_wav(wav)
                try:
                    await on_chunk(path, False, index)  # partial
                finally:
                    self._close(wav)

                index += 1
                wav = self._start_new_wav(channel_id, index, overlap_ms=self.chunk_overlap)
                deadline = monotonic() + self.chunk_secs

            # 3) –û–±—â–∏–π –ø—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å
            if (now - start_ts) >= self.max_utt_time:
                path = self._finalize_wav(wav)
                try:
                    await on_chunk(path, True, index)   # final
                finally:
                    self._close(wav)
                return

    # --- –ù–∏–∂–µ —É—Ç–∏–ª–∏—Ç—ã –∑–∞–ø–∏—Å–∏ WAV: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∞—à–∏ –≥–æ—Ç–æ–≤—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ ---
    def _start_new_wav(self, channel_id: str, index: int, overlap_ms: int = 0):
        # –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª WAV –Ω–∞ –∑–∞–ø–∏—Å—å (8kHz mono LINEAR16)
        # –ø—Ä–∏ overlap_ms –º–æ–∂–Ω–æ –ø—Ä–æ–¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –º—Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –±—É—Ñ–µ—Ä–∞, –µ—Å–ª–∏ –≤—ã —Ö—Ä–∞–Ω–∏—Ç–µ PCM-–∫–æ–ª—å—Ü–µ–≤–æ–π –±—É—Ñ–µ—Ä
        ...
    def _write_pcm(self, wav, frame_bytes: bytes):
        ...
    def _finalize_wav(self, wav) -> str:
        # –∑–∞–∫—Ä—ã—Ç—å —Ñ–∞–π–ª –∏ –≤–µ—Ä–Ω—É—Ç—å –ø—É—Ç—å
        ...
    def _close(self, wav):
        ...
    def _read_audio_frame(self) -> bytes:
        # –ø–æ–ª—É—á–∏—Ç—å –æ—á–µ—Ä–µ–¥–Ω–æ–π —Ñ—Ä–µ–π–º –∏–∑ –∫–∞–Ω–∞–ª–∞/–ø–æ—Ç–æ–∫–∞
        ...
    def _is_speech(self, frame: bytes) -> bool:
        # –≤–∞—à —Ç–µ–∫—É—â–∏–π VAD-–∫—Ä–∏—Ç–µ—Ä–∏–π: –≠–Ω–µ—Ä–≥–∏—è/–†–ú–°/–±–∏–Ω–∞—Ä–Ω—ã–π –¥–µ—Ç–µ–∫—Ç–æ—Ä
        ...
```

> –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ **–Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å** –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ –∫—É—Å–∫–∞ ‚Äî –æ–Ω –µ—ë –ª–æ–≥–∏—á–µ—Å–∫–∏ ‚Äú—Ä–µ–∂–µ—Ç‚Äù –Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ WAV-—Ñ–∞–π–ª—ã –∏ –æ—Ç–¥–∞—ë—Ç –∏—Ö –≤ `on_chunk`. –¢–∞–∫ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ ‚Äú—Å—Ç—Ä–∏–º-—ç—Ñ—Ñ–µ–∫—Ç‚Äù —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π **–±–µ–∑** –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ WS-—Å—Ç—Ä–∏–º ASR.

---

## D3) `stasis_handler_optimized.py` ‚Äî –ø—Ä–∏—ë–º –∫—É—Å–æ—á–∫–æ–≤, –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞, –ø—Ä–µ—Ñ–µ—Ç—á

–í –º–µ—Å—Ç–µ, –≥–¥–µ –≤—ã —Å–µ–π—á–∞—Å –¥–µ–ª–∞–µ—Ç–µ –æ–±—ã—á–Ω—É—é –∑–∞–ø–∏—Å—å ‚Üí –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤—ã–∑–æ–≤ ‚Äú–º—è–≥–∫–æ–≥–æ –æ–∫–Ω–∞‚Äù:

```python
# stasis_handler_optimized.py (—Ñ—Ä–∞–≥–º–µ–Ω—Ç)
async def _handle_user_speech(self, channel_id: str):
    agg = []  # –∫–æ–ø–∏–º —Ç–µ–∫—Å—Ç –∫—É—Å–æ—á–∫–æ–≤
    first_prefetch_done = False

    async def on_chunk(path: str, is_final: bool, index: int):
        text = await self.asr.recognize_file(path)  # –≤–∞—à —Ç–µ–∫—É—â–∏–π –∫–ª–∏–µ–Ω—Ç Yandex STT (HTTP)
        if text:
            agg.append(text)
            self.logger.info(f"[ASR] chunk#{index} ({'final' if is_final else 'partial'}): {text}")

        # –ü—Ä–µ—Ñ–µ—Ç—á –ª–æ–≥–∏–∫–∏ –∞–≥–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ 1‚Äì2 –∫—É—Å–æ—á–∫–æ–≤ (—É—Å–∫–æ—Ä—è–µ—Ç –æ—Ç–≤–µ—Ç)
        if not is_final and not first_prefetch_done and len(" ".join(agg)) > 20:
            first_prefetch_done = True
            asyncio.create_task(self.agent.prefetch(channel_id, " ".join(agg)))

    # –ó–∞–ø–∏—Å—å –¥–ª–∏–Ω–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∏ ‚Äú–∫–≤–∞–∑–∏—Å—Ç—Ä–∏–º–æ–º‚Äù
    await self.vad.record_until_silence_with_soft_window(channel_id, on_chunk)

    user_text = " ".join(agg).strip()
    if not user_text:
        return

    # –û–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ—Ç–≤–µ—Ç–∞: –∑–¥–µ—Å—å –º–æ–∂–µ—Ç–µ –∑–∞–±—Ä–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–µ—Ñ–µ—Ç—á–∞
    await self._answer_user(channel_id, user_text)
```

---

## D4) `ari_client.py` ‚Äî –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –º–µ—Ç–æ–¥ (–µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç) –∏ **–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –≤ barge-in**:

```python
# ari_client.py (—Ñ—Ä–∞–≥–º–µ–Ω—Ç)
class AsteriskARIClient:
    ...
    async def stop_playback(self, playback_id: str) -> bool:
        url = f"{self.base_url}/playbacks/{playback_id}"
        async with self.session.delete(url, auth=self.auth, timeout=self.timeout) as resp:
            # 200/204 => stopped; 404/409 —Å—á–∏—Ç–∞–µ–º —É—Å–ø–µ—Ö–æ–º (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ)
            return resp.status in (200, 204, 404, 409)
```

---

## D5) `stasis_handler_optimized.py` ‚Äî barge-in –≥–∞—Å–∏—Ç *–≤—Å–µ* playbacks

–í –≤–∞—à–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ `stop_tts_on_barge_in_optimized(...)` **–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ‚Äú—Ç–µ–∫—É—â–∏–π‚Äù –∏ –≤—Å–µ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ**:

```python
# stasis_handler_optimized.py (—Ñ—Ä–∞–≥–º–µ–Ω—Ç)
async def stop_tts_on_barge_in_optimized(self, channel_id: str, event_name: str):
    self.logger.info(f"üö´ [BARGE-IN] {event_name} ‚Üí stop all playbacks & queues (ch={channel_id})")

    call = self.active_calls.get(channel_id, {})

    # 1) –¢–µ–∫—É—â–∏–π playback
    current = call.get("current_playback")
    if current:
        try:
            ok = await self.ari.stop_playback(current)
            if ok:
                self.logger.info(f"üõë Stopped current playback: {current}")
        except Exception as e:
            self.logger.warning(f"stop_playback error for {current}: {e}")
        finally:
            call["current_playback"] = None
            self.active_calls[channel_id] = call

    # 2) –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ playbacks –∏–∑ —Ä–µ–µ—Å—Ç—Ä–∞ —Å–æ–±—ã—Ç–∏–π
    active_pids = [pid for pid, meta in self.playback_events.items()
                   if meta.get("channel_id") == channel_id and not meta.get("finished", True)]
    for pid in active_pids:
        try:
            ok = await self.ari.stop_playback(pid)
            if ok:
                self.logger.info(f"üõë Force stopped playback: {pid}")
            self.playback_events[pid]["finished"] = True
        except Exception as e:
            self.logger.warning(f"stop_playback error for {pid}: {e}")

    # 3) –û—á–µ—Ä–µ–¥–∏ TTS/–∑–∞–¥–∞—á–∏
    if self.parallel_tts:
        await self.parallel_tts.clear_all_queues(channel_id)

    # 4) –§–ª–∞–≥–∏
    call["user_interrupted"] = True
    call["is_speaking"] = False
    self.active_calls[channel_id] = call
    self.logger.info("‚úÖ Barge-in completed ‚Äî ready for new input")
```

> –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã **–ø–æ–¥–ø–∏—Å–∞–Ω—ã –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç–µ** —Å–æ–±—ã—Ç–∏—è `PlaybackStarted/PlaybackFinished` –∏ –ø–æ–ø–æ–ª–Ω—è–µ—Ç–µ `self.playback_events` (—Ä–µ–µ—Å—Ç—Ä –Ω—É–∂–µ–Ω –¥–ª—è –ø.2).

---

## D6) –¢–∞–π–º–∞—É—Ç—ã –∑–≤–æ–Ω–∫–∞ ‚Äî –≤—ã–Ω–µ—Å—Ç–∏ –∏–∑ ‚Äú–º–∞–≥–∏—á–µ—Å–∫–∏—Ö 30s‚Äù

–í –º–µ—Å—Ç–∞—Ö, –≥–¥–µ —Å—Ç–∞—Ä—Ç—É–µ—Ç/—Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è —Ç–∞–π–º–µ—Ä:

```python
# stasis_handler_optimized.py (—Ñ—Ä–∞–≥–º–µ–Ω—Ç)
import os
CALL_INACTIVITY_TIMEOUT = int(os.getenv("CALL_INACTIVITY_TIMEOUT", "180"))
CHANNEL_MONITOR_INTERVAL = int(os.getenv("CHANNEL_MONITOR_INTERVAL", "60"))

async def _start_call_timeout(self, channel_id: str):
    # –≤–º–µ—Å—Ç–æ sleep(30) –∏—Å–ø–æ–ª—å–∑—É–µ–º CALL_INACTIVITY_TIMEOUT
    ...

async def _monitor_channels(self):
    while True:
        await asyncio.sleep(CHANNEL_MONITOR_INTERVAL)
        # –¥–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –∫–∞–Ω–∞–ª–∞, –ø—Ä–µ–∂–¥–µ —á–µ–º –≤–µ—à–∞—Ç—å —Ç—Ä—É–±–∫—É
        ...
```

---

# E. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) Asterisk –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –Ω–∏–∑–∫–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏

**`/etc/asterisk/rtp.conf`**

```ini
[general]
rtpstart=10000
rtpend=20000
jitterbuffer=no
rtp_timeout=30
rtp_timeout_hold=60
rtp_keepalive=20
```

**`/etc/asterisk/asterisk.conf`**

```ini
[options]
transmit_silence=no
```

–ï—Å–ª–∏ TTS –∏–≥—Ä–∞–µ—Ç —á–µ—Ä–µ–∑ **bridge**, –∞ –ø—Ä–∏ barge-in DELETE –ø–æ playback‚Äô–∞–º –æ—Å—Ç–∞–≤–ª—è–µ—Ç ‚Äú—Ö–≤–æ—Å—Ç—ã‚Äù, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ‚Äú–∂—ë—Å—Ç–∫–∏–π‚Äù —Å—Ü–µ–Ω–∞—Ä–∏–π: **—É–¥–∞–ª–µ–Ω–∏–µ bridge –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ** (–¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞ –±—É—Ñ–µ—Ä–æ–≤), –∑–∞—Ç–µ–º –≤–µ—Ä–Ω—É—Ç—å –∫–∞–Ω–∞–ª –≤ –Ω–æ–≤—ã–π bridge.

---

# F. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –¢–æ–Ω–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Yandex STT

–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ HTTP-—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏, –¥–æ–±–∞–≤—å—Ç–µ:

* `max_pause_between_words_hint_ms = 2000` ‚Äî –¥–æ–ø—É—Å–∫–∞–µ—Ç –ø–∞—É–∑—ã –¥–æ 2.0s –º–µ–∂–¥—É —Å–ª–æ–≤–∞–º–∏ –±–µ–∑ ‚Äú–ª–æ–∂–Ω–æ–≥–æ –∫–æ–Ω—Ü–∞‚Äù.
* `eou_classifier_options = HIGH` ‚Äî –±–æ–ª–µ–µ ‚Äú—Ç–µ—Ä–ø–∏–º—ã–π‚Äù –∫ —Ç–∏—à–∏–Ω–µ (–ø–æ–¥–±–∏—Ä–∞–µ—Ç—Å—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ).

> –≠—Ç–æ **–¥–æ–ø–æ–ª–Ω—è–µ—Ç** –Ω–∞—à VAD/SmartDetector –∏ —Å–Ω–∏–∂–∞–µ—Ç —à–∞–Ω—Å ‚Äú–ª–æ–∂–Ω–æ–≥–æ‚Äù EOU –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ ASR.

---

# G. –ß–µ–∫-–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ø–µ—Ä–µ–¥ –≤—ã–∫–ª–∞–¥–∫–æ–π)

1. **–ö–æ—Ä–æ—Ç–∫–∞—è —Ä–µ–ø–ª–∏–∫–∞ ‚Äú–î–∞/–ù–µ—Ç‚Äù** ‚Üí —É–ª–µ—Ç–∞–µ—Ç –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫.
2. **–î–ª–∏–Ω–Ω–∞—è —Ä–µ—á—å 20‚Äì30s –±–µ–∑ –ø–∞—É–∑** ‚Üí —Ä–µ–∂–µ—Ç—Å—è –Ω–∞ 5s-—á–∞–Ω–∫–∏, –∫–∞–∂–¥—ã–π —É—Ö–æ–¥–∏—Ç –≤ ASR; –≤ –∫–æ–Ω—Ü–µ ‚Äî —Ñ–∏–Ω–∞–ª, –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ **–±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Ö–≤–æ—Å—Ç–∞**.
3. **Barge-in**: –≤–æ –≤—Ä–µ–º—è TTS —Å–∫–∞–∂–∏ ‚Äú—Å–µ–∫—É–Ω–¥–æ—á–∫—É‚Äù ‚Üí –≤ –ª–æ–≥–∞—Ö `üõë Stopped ...`, –∑–≤—É–∫ –±–æ—Ç–∞ –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è **–º–≥–Ω–æ–≤–µ–Ω–Ω–æ**, –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ç–∞—Ä—Ç—É–µ—Ç.
4. **–¢–∞–π–º–∞—É—Ç –∑–≤–æ–Ω–∫–∞**: –ø—Ä–æ—Å—Ç–∞–∏–≤–∞–π 2‚Äì3 –º–∏–Ω—É—Ç—ã ‚Üí –∞–≤—Ç–æ—Ä–∞–∑—Ä—ã–≤ –¥–æ–ª–∂–µ–Ω —Å—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ —Ä–∞–Ω–µ–µ `CALL_INACTIVITY_TIMEOUT`.
5. **–°—Ü–µ–Ω–∞—Ä–∏–π —à—É–º/–º–∏–∫—Ä–æ–ø–∞—É–∑—ã**: —Å –ø–∞—É–∑–∞–º–∏ ~1.5‚Äì2.0s –±–æ—Ç **–Ω–µ –¥–æ–ª–∂–µ–Ω** –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–≤–µ—Ä—à–∞—Ç—å –∑–∞–ø–∏—Å—å.

---

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —Å–æ–±–µ—Ä—É —ç—Ç–æ –≤ **–µ–¥–∏–Ω—ã–π `.patch`** (unified diff) –∫ —Ç–≤–æ–∏–º —Ñ–∞–π–ª–∞–º (`simple_vad_service.py`, `stasis_handler_optimized.py`, `ari_client.py`) + –ø—Ä–∏–º–µ—Ä `.env`. –¢–æ–≥–¥–∞ —Ç—ã —Å–º–æ–∂–µ—à—å –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø–∞—Ç—á –≤ Cursor –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å.

____
___



**–í–æ–ø—Ä–æ—Å:** ¬´–î–∞–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π diff-–ø–∞–∫–µ—Ç: –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π barge-in + ‚Äú–º—è–≥–∫–æ–µ –æ–∫–Ω–æ‚Äù (–∫–≤–∞–∑–∏—Å—Ç—Ä–∏–º) –¥–ª—è –≤—Ö–æ–¥—è—â–µ–≥–æ –∞—É–¥–∏–æ + env-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã. –ë–µ–∑ –∑–∞–≥–ª—É—à–µ–∫, —á—Ç–æ–±—ã –∞–≥–µ–Ω—Ç IDE —Å—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω–∏–ª¬ª.

–û–∫ ‚Äî –Ω–∏–∂–µ –µ–¥–∏–Ω—ã–π –Ω–∞–±–æ—Ä –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –ø—Ä–∞–≤–æ–∫. –§–æ—Ä–º–∞—Ç ‚Äî unified diff. –ü—Ä–∏–º–µ–Ω—è–π —á–µ—Ä–µ–∑ `git apply`.

---

# 1) `env.example` ‚Äî –Ω–æ–≤—ã–µ/–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (—Å–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª, –µ—Å–ª–∏ –Ω–µ—Ç)

```diff
*** /dev/null
--- a/env.example
***************
+############################
+# Voice In (VAD / Smart)  #
+############################
+VAD_SILENCE_TIMEOUT=2.0
+VAD_MIN_RECORDING_TIME=1.0
+VAD_MAX_RECORDING_TIME=15.0
+
+SPEECH_SILENCE_TIMEOUT=2.0
+SPEECH_MIN_DURATION=0.6
+
+# –ü–ª–∞–≤–Ω–æ—Å—Ç—å –≤—Ö–æ–¥–∞
+INPUT_DEBOUNCE_MS=1000
+BARGE_IN_GUARD_MS=300
+
+############################
+# Soft window (quasi-stream)
+############################
+# –†–∞–∑–º–µ—Ä –æ–¥–Ω–æ–≥–æ –∫—É—Å–∫–∞ –≤—Ö–æ–¥—è—â–µ–π —Ä–µ—á–∏ (—Å–µ–∫)
+CHUNK_STREAMING_SECONDS=5
+# –ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –º–µ–∂–¥—É –∫—É—Å–∫–∞–º–∏ (–º—Å) –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤–æ–π —Å–∫–ª–µ–π–∫–∏
+CHUNK_OVERLAP_MS=150
+# –û–±—â–∏–π –ø—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å –≤—Å–µ–π —Ä–µ–ø–ª–∏–∫–∏ (—Å–µ–∫)
+MAX_UTTERANCE_SECONDS=60
+# –í–∫–ª—é—á–µ–Ω–∏–µ ‚Äú–º—è–≥–∫–æ–≥–æ –æ–∫–Ω–∞‚Äù
+USE_SOFT_WINDOW_INPUT=true
+
+############################
+# Call lifecycle
+############################
+CALL_INACTIVITY_TIMEOUT=180
+CHANNEL_MONITOR_INTERVAL=60
+
+############################
+# Barge-in
+############################
+BARGE_IN_ENABLED=true
```

> –ï—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å `.env` ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π –∑–Ω–∞—á–µ–Ω–∏—è —Å —ç—Ç–∏–º —à–∞–±–ª–æ–Ω–æ–º (—É–¥–∞–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã —Ç–∏–ø–∞ `SPEECH_MAX_RECORDING_TIME=8.0`).

---

# 2) `ari_client.py` ‚Äî –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

```diff
--- a/ari_client.py
+++ b/ari_client.py
@@
 class AsteriskARIClient:
@@
     async def play_sound(self, channel_id: str, media_uri: str) -> str:
         """
         –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –∑–≤—É–∫ –Ω–∞ –∫–∞–Ω–∞–ª–µ. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç playback_id.
         """
         # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
         return playback_id
+
+    async def stop_playback(self, playback_id: str) -> bool:
+        """
+        –ñ—ë—Å—Ç–∫–æ –∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ.
+        DELETE /playbacks/{playbackId}
+        """
+        url = f"{self.base_url}/playbacks/{playback_id}"
+        async with self.session.delete(url, auth=self.auth, timeout=self.timeout) as resp:
+            # —Å—á–∏—Ç–∞–µ–º —É—Å–ø–µ—Ö–æ–º 200/204 –∏ –≥–æ–Ω–∫–∏ 404/409
+            return resp.status in (200, 204, 404, 409)
```

---

# 3) `simple_vad_service.py` ‚Äî ‚Äú–º—è–≥–∫–æ–µ –æ–∫–Ω–æ‚Äù (–∫–≤–∞–∑–∏—Å—Ç—Ä–∏–º) –¥–ª—è –≤—Ö–æ–¥—è—â–µ–≥–æ –∞—É–¥–∏–æ

```diff
--- a/simple_vad_service.py
+++ b/simple_vad_service.py
@@
+import os
+from time import monotonic
@@
 class SimpleVADService:
     def __init__(self, logger, *args, **kwargs):
         self.logger = logger
-        self.silence_timeout = 1.2
-        self.min_rec_time = 1.5
-        self.max_rec_time = 6.0
+        # —á–∏—Ç–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ env
+        self.silence_timeout = float(os.getenv("VAD_SILENCE_TIMEOUT", "2.0"))
+        self.min_rec_time    = float(os.getenv("VAD_MIN_RECORDING_TIME", "1.0"))
+        # –ø—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å ‚Äú–≤—Å–µ–π —Ä–µ–ø–ª–∏–∫–∏‚Äù (—Å–µ–∫)
+        self.max_utt_time    = float(os.getenv("MAX_UTTERANCE_SECONDS", "60"))
+        # –º—è–≥–∫–æ–µ –æ–∫–Ω–æ (–¥–ª–∏–Ω–∞ –æ–¥–Ω–æ–≥–æ –∫—É—Å–∫–∞)
+        self.chunk_secs      = float(os.getenv("CHUNK_STREAMING_SECONDS", "5"))
+        self.chunk_overlap   = int(os.getenv("CHUNK_OVERLAP_MS", "150"))
@@
     async def record_until_silence(self, channel_id: str) -> str:
         """
         –°—Ç–∞—Ä–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî –∑–∞–ø–∏—Å—å –æ–¥–Ω–∏–º —Ñ–∞–π–ª–æ–º –¥–æ —Ç–∏—à–∏–Ω—ã/–ø–æ—Ç–æ–ª–∫–∞.
         –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Ç—å –∫ WAV.
         """
         # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
         return wav_path
+
+    async def record_until_silence_with_soft_window(self, channel_id: str, on_chunk):
+        """
+        –ù–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è: –¥–ª–∏–Ω–Ω–∞—è —Ä–µ—á—å —Ä–µ–∂–µ—Ç—Å—è –Ω–∞ –∫—É—Å–∫–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–ª–∏–Ω—ã,
+        –ø—Ä–∏ —ç—Ç–æ–º –∑–∞–ø–∏—Å—å –ù–ï –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ –∫—É—Å–∫–∞.
+        on_chunk(path, is_final, index) ‚Äî –≤–∞—à –∫–æ–ª–±—ç–∫: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç WAV –≤ ASR.
+        """
+        start_ts   = monotonic()
+        index      = 0
+        last_voice = monotonic()
+        deadline   = monotonic() + self.chunk_secs
+
+        wav = self._start_new_wav(channel_id, index)
+
+        while True:
+            frame = await self._read_audio_frame()
+            if frame is None:
+                break
+
+            self._write_pcm(wav, frame)
+            now = monotonic()
+
+            if self._is_speech(frame):
+                last_voice = now
+
+            # —Ç—Ä–∏–≥–≥–µ—Ä 1: —Ç–∏—à–∏–Ω–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ‚Üí —Ñ–∏–Ω–∞–ª –≤—Å–µ–π —Ä–µ–ø–ª–∏–∫–∏
+            if (now - last_voice) >= self.silence_timeout and (now - start_ts) >= self.min_rec_time:
+                path = self._finalize_wav(wav)
+                try:
+                    await on_chunk(path, True, index)
+                finally:
+                    self._close(wav)
+                return
+
+            # —Ç—Ä–∏–≥–≥–µ—Ä 2: –∏—Å—Ç–µ–∫–ª–æ –æ–∫–Ω–æ ‚Üí –∑–∞–∫—Ä—ã–≤–∞–µ–º partial –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–ø–∏—Å—å
+            if now >= deadline:
+                path = self._finalize_wav(wav)
+                try:
+                    await on_chunk(path, False, index)
+                finally:
+                    self._close(wav)
+                index += 1
+                wav = self._start_new_wav(channel_id, index, overlap_ms=self.chunk_overlap)
+                deadline = monotonic() + self.chunk_secs
+
+            # –æ–±—â–∏–π –ø—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å –≤—Å–µ–π —Ä–µ–ø–ª–∏–∫–∏
+            if (now - start_ts) >= self.max_utt_time:
+                path = self._finalize_wav(wav)
+                try:
+                    await on_chunk(path, True, index)
+                finally:
+                    self._close(wav)
+                return
```

> –í —ç—Ç–æ–º –ø–∞—Ç—á–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤–∞—à–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã: `_start_new_wav(...)`, `_write_pcm(...)`, `_finalize_wav(...)`, `_read_audio_frame()`, `_is_speech(...)`. –û–Ω–∏ —É–∂–µ –µ—Å—Ç—å –≤ –ø—Ä–æ–µ–∫—Ç–µ ‚Äî –≤—ã –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç–µ –Ω–æ–≤—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∑–∞–ø–∏—Å–∏.

---

# 4) `stasis_handler_optimized.py` ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω—ã–π barge-in –∏ –≤—Ö–æ–¥ ‚Äú–º—è–≥–∫–∏–º –æ–∫–Ω–æ–º‚Äù

```diff
--- a/stasis_handler_optimized.py
+++ b/stasis_handler_optimized.py
@@
-import asyncio, time, json, logging
+import os, asyncio, time, json, logging
 from typing import Dict, Any
@@
 class StasisHandlerOptimized:
     def __init__(self, ari, parallel_tts, filler_tts, asr, agent, log_store):
         self.ari = ari
         self.parallel_tts = parallel_tts
         self.filler_tts = filler_tts
         self.asr = asr
         self.agent = agent
         self.log_store = log_store
         self.logger = logging.getLogger(__name__)
-        self.active_calls: Dict[str, Dict[str, Any]] = {}
+        self.active_calls: Dict[str, Dict[str, Any]] = {}
+        # —Ä–µ–µ—Å—Ç—Ä playbacks –¥–ª—è —Ç–æ—Ç–∞–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (barge-in)
+        self.playback_events: Dict[str, Dict[str, Any]] = {}
+        # —Ñ–∏—á–∏/—Ç–∞–π–º–∏–Ω–≥–∏ –∏–∑ env
+        self.use_soft_input = os.getenv("USE_SOFT_WINDOW_INPUT", "true").lower() == "true"
+        self.barge_in_enabled = os.getenv("BARGE_IN_ENABLED", "true").lower() == "true"
+        self.call_inactivity_timeout = int(os.getenv("CALL_INACTIVITY_TIMEOUT", "180"))
+        self.channel_monitor_interval = int(os.getenv("CHANNEL_MONITOR_INTERVAL", "60"))
@@
     async def on_event(self, event: Dict[str, Any]):
         et = event.get("type")
         # ... –≤–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–∞–∑–±–æ—Ä —Å–æ–±—ã—Ç–∏–π ...
+        if et == "PlaybackStarted":
+            pid = event.get("playback", {}).get("id")
+            ch  = event.get("playback", {}).get("target_uri", "").split(":")[-1] or event.get("channel", {}).get("id")
+            if pid:
+                self.playback_events[pid] = {"channel_id": ch, "finished": False}
+                call = self.active_calls.setdefault(ch, {})
+                call["current_playback"] = pid
+                self.active_calls[ch] = call
+                self.logger.info(f"[ARI] PlaybackStarted id={pid} ch={ch}")
+        elif et == "PlaybackFinished":
+            pid = event.get("playback", {}).get("id")
+            ch  = event.get("playback", {}).get("target_uri", "").split(":")[-1] or event.get("channel", {}).get("id")
+            if pid and pid in self.playback_events:
+                self.playback_events[pid]["finished"] = True
+                if ch in self.active_calls and self.active_calls[ch].get("current_playback") == pid:
+                    self.active_calls[ch]["current_playback"] = None
+                self.logger.info(f"[ARI] PlaybackFinished id={pid} ch={ch}")
@@
-    async def stop_tts_on_barge_in_optimized(self, channel_id: str, event_name: str):
-        # –±—ã–ª–æ: —á–∏—Å—Ç–∏–ª–∏ –æ—á–µ—Ä–µ–¥–∏, –Ω–æ –Ω–µ –≥–∞—Å–∏–ª–∏ —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è
-        if self.parallel_tts:
-            await self.parallel_tts.clear_all_queues(channel_id)
-        self.logger.info("Barge-in: queues cleared, ready for new input")
+    async def stop_tts_on_barge_in_optimized(self, channel_id: str, event_name: str):
+        if not self.barge_in_enabled:
+            return
+        self.logger.info(f"üö´ [BARGE-IN] {event_name} ‚Üí stop all playbacks & queues (ch={channel_id})")
+        call = self.active_calls.get(channel_id, {})
+        # 1) —Ç–µ–∫—É—â–∏–π playback
+        current = call.get("current_playback")
+        if current:
+            try:
+                ok = await self.ari.stop_playback(current)
+                if ok:
+                    self.logger.info(f"üõë Stopped current playback: {current}")
+            except Exception as e:
+                self.logger.warning(f"stop_playback error for {current}: {e}")
+            finally:
+                call["current_playback"] = None
+                self.active_calls[channel_id] = call
+        # 2) –≤—Å–µ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∏–∑ —Ä–µ–µ—Å—Ç—Ä–∞
+        active_pids = [pid for pid, meta in self.playback_events.items()
+                       if meta.get("channel_id") == channel_id and not meta.get("finished", True)]
+        for pid in active_pids:
+            try:
+                ok = await self.ari.stop_playback(pid)
+                if ok:
+                    self.logger.info(f"üõë Force stopped playback: {pid}")
+                self.playback_events[pid]["finished"] = True
+            except Exception as e:
+                self.logger.warning(f"stop_playback error for {pid}: {e}")
+        # 3) –æ—á–µ—Ä–µ–¥–∏/—Ç–∞—Å–∫–∏ tts
+        if self.parallel_tts:
+            await self.parallel_tts.clear_all_queues(channel_id)
+        # 4) —Ñ–ª–∞–≥–∏
+        call["user_interrupted"] = True
+        call["is_speaking"] = False
+        self.active_calls[channel_id] = call
+        self.logger.info("‚úÖ Barge-in completed ‚Äî ready for new input")
@@
-    async def _handle_user_speech(self, channel_id: str):
-        # —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞: –∑–∞–ø–∏—Å—å –æ–¥–Ω–∏–º —Ñ–∞–π–ª–æ–º
-        wav = await self.vad.record_until_silence(channel_id)
-        text = await self.asr.recognize_file(wav)
-        if not text:
-            return
-        await self._answer_user(channel_id, text)
+    async def _handle_user_speech(self, channel_id: str):
+        if not self.use_soft_input:
+            # —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º –ø—É—Ç–µ–º
+            wav = await self.vad.record_until_silence(channel_id)
+            text = await self.asr.recognize_file(wav)
+            if not text:
+                return
+            await self._answer_user(channel_id, text)
+            return
+
+        # –Ω–æ–≤—ã–π –ø—É—Ç—å: –º—è–≥–∫–æ–µ –æ–∫–Ω–æ (–∫–≤–∞–∑–∏—Å—Ç—Ä–∏–º)
+        agg = []
+        first_prefetch = False
+
+        async def on_chunk(path: str, is_final: bool, index: int):
+            t = await self.asr.recognize_file(path)
+            if t:
+                agg.append(t)
+                self.logger.info(f"[ASR] chunk#{index} ({'final' if is_final else 'partial'}): {t}")
+            # –ø—Ä–µ—Ñ–µ—Ç—á: –ø–æ—Å–ª–µ 1‚Äì2 –∫—É—Å–æ—á–∫–æ–≤ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≥–µ–Ω—Ç –∑–∞—Ä–∞–Ω–µ–µ
+            nonlocal first_prefetch
+            if not is_final and not first_prefetch and len(" ".join(agg)) > 20:
+                first_prefetch = True
+                asyncio.create_task(self.agent.prefetch(channel_id, " ".join(agg)))
+
+        await self.vad.record_until_silence_with_soft_window(channel_id, on_chunk)
+        user_text = " ".join(agg).strip()
+        if not user_text:
+            return
+        await self._answer_user(channel_id, user_text)
```

---

# 5) (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) `rtp.conf`/`asterisk.conf` ‚Äî —Å–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∏–∑–∫–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏

```diff
*** /dev/null
--- a/deploy/asterisk/rtp.conf.suggested
***************
+[general]
+rtpstart=10000
+rtpend=20000
+jitterbuffer=no
+rtp_timeout=30
+rtp_timeout_hold=60
+rtp_keepalive=20
```

```diff
*** /dev/null
--- a/deploy/asterisk/asterisk.conf.suggested
***************
+[options]
+transmit_silence=no
```

> –≠—Ç–∏ —Ñ–∞–π–ª—ã ‚Äî —Å–ø—Ä–∞–≤–æ—á–Ω—ã–µ ‚Äú—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ‚Äù. –ü—Ä–∏–º–µ–Ω–∏ –ø–æ –º–µ—Å—Ç—É –≤ —Å–≤–æ–µ–π —É—Å—Ç–∞–Ω–æ–≤–∫–µ Asterisk.

---

## –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å

1. –°–æ—Ö—Ä–∞–Ω–∏ –≤—Å–µ –∫—É—Å–∫–∏ –≤ —Ñ–∞–π–ª, –Ω–∞–ø—Ä–∏–º–µ—Ä `voice-fixes.patch`.
2. –í –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ:

   ```bash
   git checkout -b feature/voice-fixes
   git apply voice-fixes.patch
   git add -A
   git commit -m "Voice fixes: idempotent barge-in + soft-window input + env"
   ```
3. –ü—Ä–æ–ø–∏—à–∏ –∑–Ω–∞—á–µ–Ω–∏—è –≤ `.env` (–∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π `env.example` ‚Üí `.env`).
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å—ã.
5. –ü—Ä–æ—Ç–µ—Å—Ç–∏ –ø–æ —á–µ–∫-–ª–∏—Å—Ç—É:

   * –¥–ª–∏–Ω–Ω–∞—è —Ä–µ—á—å 20‚Äì30 —Å ‚Üí —Ä–µ–∂–µ—Ç—Å—è –Ω–∞ 5-—Å–µ–∫. –∫—É—Å–∫–∏, –±–æ—Ç **–¥–æ—Å–ª—É—à–∏–≤–∞–µ—Ç**;
   * –±–∞—Ä–¥–∂-–∏–Ω –≤–æ –≤—Ä–µ–º—è TTS ‚Üí –≤ –ª–æ–≥–µ `üõë Stopped ...`, –∑–≤—É–∫ –±–æ—Ç–∞ –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è **–º–≥–Ω–æ–≤–µ–Ω–Ω–æ**;
   * –∫–æ—Ä–æ—Ç–∫–∏–µ ‚Äú–î–∞/–ù–µ—Ç‚Äù ‚Üí —É–ª–µ—Ç–∞—é—Ç –±–µ–∑ –ª–∏—à–Ω–µ–π –∑–∞–¥–µ—Ä–∂–∫–∏;
   * –ø—Ä–æ—Å—Ç–æ–∏ –Ω–µ —Ä–æ–Ω—è—é—Ç –∑–≤–æ–Ω–æ–∫ —Ä–∞–Ω–µ–µ `CALL_INACTIVITY_TIMEOUT`.

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –¥–æ–ø–æ–ª–Ω—é –ø–∞—Ç—á –±–ª–æ–∫–æ–º –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ Yandex STT (`max_pause_between_words_hint_ms=2000`, `eou_classifier_options=HIGH`) –≤ —Ç–≤–æ—ë–º `yandex_asr_service.py`.
