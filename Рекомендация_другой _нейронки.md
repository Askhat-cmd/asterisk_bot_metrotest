
# 1) –§–∏–ª–ª–µ—Ä—ã –≤–∏–¥–Ω—ã –≤ –ª–æ–≥–∞—Ö, –Ω–æ –∏—Ö –Ω–µ —Å–ª—ã—à–Ω–æ

**–ß—Ç–æ –≤–∏–∂—É –ø–æ –ª–æ–≥–∞–º (—Ñ–∞–∫—Ç—ã):**

* –§–∏–ª–ª–µ—Ä—ã —Ä–µ–∞–ª—å–Ω–æ —Å–∏–Ω—Ç–µ–∑–∏—Ä—É—é—Ç—Å—è –∏ –∫—ç—à–∏—Ä—É—é—Ç—Å—è (`Instant cached filler: '–•–º,'`, `–•–æ—Ä–æ—à–æ,`) ‚Äî –∑–Ω–∞—á–∏—Ç TTS OK.
* –°—Ä–∞–∑—É –ø–æ—Å–ª–µ ASR —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è WAV-—Ñ–∞–π–ª –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ ARI –Ω–∞ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ (status=201, state=queued), –∑–∞—Ç–µ–º –æ—Ç–º–µ—á–∞–µ—Ç—Å—è ¬´Filler played: 0.81s¬ª. –û–¥–Ω–∞–∫–æ —Ç—ã —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∑–≤—É–∫–∞ –Ω–µ —Å–ª—ã—à–∏—à—å. 

**–ü—Ä–∏—á–∏–Ω–∞ (–ø–æ –ª–æ–≥–∞–º –∏ —Ç–∏–ø–∏—á–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é Asterisk):**

* –§–∏–ª–ª–µ—Ä—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—é—Ç—Å—è –∏–∑ **–¥—Ä—É–≥–æ–≥–æ –ø—É—Ç–∏**, —á–µ–º –æ—Å–Ω–æ–≤–Ω–∞—è –æ–∑–≤—É—á–∫–∞ —á–∞–Ω–∫–æ–≤. –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ, —á—Ç–æ chunk-TTS —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ—Ç—Å—è –∏–∑ **`/usr/share/asterisk/sounds/ru/‚Ä¶`** –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç; –∞ —Ñ–∏–ª–ª–µ—Ä—ã ‚Äî –∫–∞–∫ **`/var/lib/asterisk/sounds/stream_‚Ä¶wav`** (–±–µ–∑ `ru/` –∏ –¥—Ä—É–≥–æ–π –±–∞–∑–æ–≤—ã–π –∫–∞—Ç–∞–ª–æ–≥). –ü—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –ª–æ–∫–∞–ª–∏ `ru` Asterisk –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –∏—â–µ—Ç —Ñ–∞–π–ª—ã –≤ —è–∑—ã–∫–æ–≤–æ–π –ø–æ–¥–ø–∞–ø–∫–µ (`‚Ä¶/sounds/ru/`), –∏ –∏–∑-–∑–∞ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø—É—Ç–µ–π/—è–∑—ã–∫–∞ –æ—Ç—ã–≥—Ä—ã—à –º–æ–∂–µ—Ç ¬´—É—Å–ø–µ—à–Ω–æ –∑–∞–∫–æ–Ω—á–∏—Ç—å—Å—è¬ª –±–µ–∑ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞—É–¥–∏–æ. –†–µ—à–µ–Ω–∏–µ ‚Äî **—É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø—É—Ç—å –∏ —è–∑—ã–∫** –¥–ª—è —Ñ–∏–ª–ª–µ—Ä–æ–≤ —Å –æ—Å–Ω–æ–≤–Ω–æ–π –æ–∑–≤—É—á–∫–æ–π (–∫–∞–∫ —É chunk-TTS). –≠—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–≤–æ–µ–π –≥–∏–ø–æ—Ç–µ–∑–æ–π –≤ `asterisk-fixes.md`.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–≥–æ—Ç–æ–≤—ã–µ –ø—Ä–∞–≤–∫–∏, –±–µ–∑ –∑–∞–≥–ª—É—à–µ–∫):**

1. –í –º–µ—Å—Ç–µ, –≥–¥–µ —Ç—ã —Å–æ—Ö—Ä–∞–Ω—è–µ—à—å –∞—É–¥–∏–æ —Ñ–∏–ª–ª–µ—Ä–∞ (–æ–±—ã—á–Ω–æ `play_instant_filler()` –≤ `stasis_handler_optimized.py`), **–ø–∏—à–µ–º —Å—Ç—Ä–æ–≥–æ –≤ —è–∑—ã–∫–æ–≤—É—é –ø–∞–ø–∫—É** –∏ **–¥–∞—ë–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø—Ä–∞–≤–∞**:

```python
import os, time, pwd, grp

async def play_instant_filler(self, channel_id: str, filler_text: str) -> None:
    audio: bytes = await self.filler_tts.get_instant_filler(filler_text)
    ts = int(time.time() * 1000)

    # –ï–î–ò–ù–´–ô –ø—É—Ç—å –∫–∞–∫ —É chunk-TTS
    out_dir = "/usr/share/asterisk/sounds/ru"
    os.makedirs(out_dir, exist_ok=True)

    fname = f"filler_{channel_id}_{ts}.wav"
    fpath = os.path.join(out_dir, fname)

    with open(fpath, "wb") as f:
        f.write(audio)

    # –í–ª–∞–¥–µ–ª–µ—Ü/–ø—Ä–∞–≤–∞, —á—Ç–æ–±—ã Asterisk —Ç–æ—á–Ω–æ —á–∏—Ç–∞–ª
    try:
        uid = pwd.getpwnam("asterisk").pw_uid
        gid = grp.getgrnam("asterisk").gr_gid
        os.chown(fpath, uid, gid)
    except Exception:
        pass
    os.chmod(fpath, 0o644)

    # –Ø–í–ù–û —É–∫–∞–∂–µ–º —Ä—É—Å—Å–∫—É—é –¥–æ—Ä–æ–∂–∫—É –≤ media_uri
    media_uri = f"sound:ru/{os.path.splitext(fname)[0]}"

    playback_id = await self.ari.play_sound(channel_id, media_uri)
    if playback_id:
        self.active_calls.setdefault(channel_id, {})["current_playback"] = playback_id
        self.playback_events[playback_id] = {"channel_id": channel_id, "finished": False}
```

2. –í `filler_tts.py` –¥–æ–±–∞–≤—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Ä–∞–∑–º–µ—Ä–∞, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å ¬´–ø—É—Å—Ç—ã–µ¬ª –±–∞–π—Ç—ã (—Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–≤–æ–∏–º —á–µ—Ä–Ω–æ–≤–∏–∫–æ–º):

```python
self.logger.info(f"üìè Filler audio size: {len(audio)} bytes for '{filler_text}'")
if len(audio) < 1000:
    self.logger.warning(f"‚ö†Ô∏è Suspicious small filler size: {len(audio)} bytes")
```

(–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –±—ã—Å—Ç—Ä–æ —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Ñ–æ—Ä–º–∞—Ç–∞/—Å—ç–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –≤–æ–∑–Ω–∏–∫–Ω–µ—Ç.) 

3. –î–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ ‚Äî **–æ–¥–∏–Ω–∞–∫–æ–≤–∞—è —Å—Ö–µ–º–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è** –¥–ª—è –≤—Å–µ—Ö –∑–≤—É–∫–æ–≤: –∫–∞–∫ –∏ chunks, –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç—å —Ñ–∏–ª–ª–µ—Ä—ã —á–µ—Ä–µ–∑ `sound:ru/<name>` –∏–∑ `/usr/share/asterisk/sounds/ru/‚Ä¶`. –≠—Ç–æ –∏—Å–∫–ª—é—á–∏—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –≤ –ø—É—Ç—è—Ö/—è–∑—ã–∫–∞—Ö. 

**–ë—ã—Å—Ç—Ä—ã–π smoke-test –ø–æ—Å–ª–µ –ø—Ä–∞–≤–æ–∫:**

* –°–æ–≤–µ—Ä—à–∏ –∑–≤–æ–Ω–æ–∫ ‚Üí –¥–æ–∂–¥–∏—Å—å –ª—é–±–æ–≥–æ `Instant cached filler`.
* –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ `‚úÖ Filler file exists: /usr/share/asterisk/sounds/ru/filler_‚Ä¶` –∏ **—Ä–µ–∞–ª—å–Ω—ã–π –∑–≤—É–∫** –≤ —Ç—Ä—É–±–∫–µ. 

# 2) –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –±–æ—Ç–∞ (barge-in) –Ω–µ –≥–∞—Å–∏—Ç —Ç–µ–∫—É—â–∏–π –∑–≤—É–∫

**–ß—Ç–æ –≤–∏–∂—É –ø–æ –ª–æ–≥–∞–º (—Ñ–∞–∫—Ç—ã):**

* –°–∞–º–∞ —Ä–µ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è: VAD –∑–∞–≤–µ—Ä—à–∞–µ—Ç –∑–∞–ø–∏—Å—å, ASR —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç —Ç–µ–∫—Å—Ç.
* –¢–≤–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ barge-in **–æ—á–∏—â–∞–µ—Ç –æ—á–µ—Ä–µ–¥–∏** ParallelTTS (`Cleared all queues‚Ä¶`) –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç ¬´ready for new input¬ª, –Ω–æ **–Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Ç–µ–∫—É—â–µ–≥–æ ARI-playback**. –ó–Ω–∞—á–∏—Ç, –ø–æ—Ç–æ–∫(–∏) —É–∂–µ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º–æ–≥–æ –∞—É–¥–∏–æ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç –∑–≤—É—á–∞—Ç—å, –∏ —Ç—ã –Ω–µ –º–æ–∂–µ—à—å ¬´–ø–µ—Ä–µ–±–∏—Ç—å¬ª –±–æ—Ç–∞ –≥–æ–ª–æ—Å–æ–º. 

**–ü—Ä–∏—á–∏–Ω–∞:**

* –û—á–∏—â–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–µ–π TTS –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–æ, —á—Ç–æ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–æ –≤ Asterisk. –ù—É–∂–Ω–æ **—è–≤–Ω–æ –≤—ã–∑–≤–∞—Ç—å ARI `DELETE /playbacks/{id}`** –¥–ª—è **—Ç–µ–∫—É—â–µ–≥–æ** –∏ **–≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö** –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º. –†–æ–≤–Ω–æ —ç—Ç–æ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è –¥–æ–¥–µ–ª–∞—Ç—å –≤ —Ç–≤–æ—ë–º `asterisk-fixes.md`. 

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–≥–æ—Ç–æ–≤—ã–µ –ø—Ä–∞–≤–∫–∏, –±–µ–∑ –∑–∞–≥–ª—É—à–µ–∫):**

1. –í `ari_client.py` –¥–æ–±–∞–≤—å –º–µ—Ç–æ–¥ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:

```python
class AsteriskARIClient:
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...

    async def stop_playback(self, playback_id: str) -> bool:
        # DELETE /playbacks/{playbackId}
        url = f"{self.base_url}/playbacks/{playback_id}"
        async with self.session.delete(url, auth=self.auth, timeout=self.timeout) as resp:
            return resp.status in (200, 204)
```

2. –í `stasis_handler_optimized.py` ‚Äî —É—Å–∏–ª–∏ barge-in:

```python
async def stop_tts_on_barge_in_optimized(self, channel_id: str, event_name: str):
    call = self.active_calls.get(channel_id, {})
    self.logger.info(f"üö´ [OPTIMIZED BARGE-IN] {event_name} ‚Üí stopping all TTS processing")

    # 1) –ì–∞—Å–∏–º "—Ç–µ–∫—É—â–∏–π" playback, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    current = call.get("current_playback")
    if current:
        try:
            async with self.ari as ari:
                ok = await ari.stop_playback(current)
                if ok:
                    self.logger.info(f"üõë Stopped current playback: {current}")
        except Exception as e:
            self.logger.error(f"‚ùå Failed to stop playback {current}: {e}")

    # 2) –ì–∞—Å–∏–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ playbacks, –∑–∞–º–µ—á–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º
    if hasattr(self, "playback_events"):
        active_for_channel = [pid for pid, meta in self.playback_events.items()
                              if meta.get("channel_id") == channel_id and not meta.get("finished", True)]
        for pid in active_for_channel:
            try:
                async with self.ari as ari:
                    ok = await ari.stop_playback(pid)
                    if ok:
                        self.logger.info(f"üõë Force stopped playback: {pid}")
                self.playback_events[pid]["finished"] = True
            except Exception as e:
                self.logger.warning(f"‚ö†Ô∏è Could not stop playback {pid}: {e}")

    # 3) –ß–∏—Å—Ç–∏–º –æ—á–µ—Ä–µ–¥–∏ –∏ –æ—Ç–º–µ–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ TTS
    if self.parallel_tts:
        await self.parallel_tts.clear_all_queues(channel_id)

    # 4) –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    call["user_interrupted"] = True
    call["current_playback"] = None
    call["is_speaking"] = False
    self.active_calls[channel_id] = call

    self.logger.info("‚úÖ Barge-in processing completed - ready for new input")
```

(–õ–æ–≥-—Å—Ç—Ä–æ–∫–∏ `üõë Stopped current playback:` –∏ `üõë Force stopped playback:` —è –æ—Å—Ç–∞–≤–∏–ª –ø—Ä–µ–¥–Ω–∞–º–µ—Ä–µ–Ω–Ω–æ ‚Äî –ø–æ –Ω–∏–º —Å—Ä–∞–∑—É –≤–∏–¥–Ω–æ, —á—Ç–æ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ **—Ä–µ–∞–ª—å–Ω–æ** —Å—Ä–∞–±–æ—Ç–∞–ª–æ, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –æ—á–µ—Ä–µ–¥–∏ –ø–æ—á–∏—Å—Ç–∏–ª–∏—Å—å.) 

3. –í `parallel_tts.py` ‚Äî —Ç—Ä–µ–∫–∞–π –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è, —á—Ç–æ–±—ã –ø.2 –º–æ–≥ –∏—Ö –ø–æ–≥–∞—Å–∏—Ç—å:

```python
from collections import defaultdict

class ParallelTTSProcessor:
    def __init__(self, ...):
        # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
        self.active_playbacks = defaultdict(set)  # channel_id -> {playback_ids}

    async def play_chunk(self, channel_id: str, chunk_path_no_ext: str):
        playback_id = await self.ari.play_sound(channel_id, f"sound:ru/{chunk_path_no_ext}")
        if playback_id:
            self.active_playbacks[channel_id].add(playback_id)
            self.logger.info(f"üéµ Added playback {playback_id} to active tracking")

    def on_playback_finished(self, playback_id: str, channel_id: str):
        if channel_id in self.active_playbacks:
            self.active_playbacks[channel_id].discard(playback_id)
            self.logger.info(f"üèÅ Removed playback {playback_id} from active tracking")

    async def clear_all_queues(self, channel_id: str):
        # –æ—Ç–º–µ–Ω–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ async-tasks TTS + –æ—á–∏—Å—Ç–∏—Ç—å –æ—á–µ—Ä–µ–¥–∏ –∫–∞–∫ —É —Ç–µ–±—è
        # –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ playbacks –Ω–∞ –∫–∞–Ω–∞–ª–µ:
        for pid in list(self.active_playbacks.get(channel_id, set())):
            try:
                ok = await self.ari.stop_playback(pid)
                if ok:
                    self.logger.info(f"üõë Stopped active playback: {pid}")
            except Exception as e:
                self.logger.warning(f"Could not stop playback {pid}: {e}")
        self.active_playbacks[channel_id].clear()
```

(–°–≤—è–∑–∫–∞: `stasis_handler_optimized` –ø—Ä–∏ —Å–æ–±—ã—Ç–∏–∏ `PlaybackStarted/Finished` –¥–æ–ª–∂–µ–Ω –≤—ã–∑—ã–≤–∞—Ç—å `on_playback_finished()` ‚Äî —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å –∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä—Ç–∞/–∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤—å –≤—ã–∑–æ–≤ —Ö—É–∫–∞ —Ç—É–¥–∞.) 

**–ë—ã—Å—Ç—Ä—ã–π smoke-test barge-in:**

* –ó–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞, –¥–æ–∂–¥–∏—Å—å –Ω–∞—á–∞–ª–∞ –æ–∑–≤—É—á–∫–∏. –°–∫–∞–∂–∏ —Ñ—Ä–∞–∑—É –ø–æ–≤–µ—Ä—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´—Å—Ç–æ–ø¬ª).
* –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —Å—Ç—Ä–æ–∫–∏ **`üõë Stopped current playback ‚Ä¶`**, **`üõë Force stopped playback ‚Ä¶`** –∏/–∏–ª–∏ **`üõë Stopped active playback ‚Ä¶`** ‚Äî –∏ **–∑–≤—É–∫ –±–æ—Ç–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è**. 

---

## –†–µ–∑—é–º–µ

* **–§–∏–ª–ª–µ—Ä—ã**: –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ TTS, –∞ –≤ **–ø—É—Ç–∏/—è–∑—ã–∫–æ–≤–æ–π –ø–∞–ø–∫–µ**. –ü–∏—à–µ–º –≤ `/usr/share/asterisk/sounds/ru/‚Ä¶` –∏ –∏–≥—Ä–∞–µ–º `sound:ru/<name>`. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Ñ–∏–ª–ª–µ—Ä—ã –¥–æ–ª–∂–Ω—ã —Ä–µ–∞–ª—å–Ω–æ –∑–≤—É—á–∞—Ç—å.
* **Barge-in**: –Ω—É–∂–Ω–æ **—Ä–µ–∞–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å** —Ç–µ–∫—É—â–∏–µ ARI-playbacks (`DELETE /playbacks/{id}`) + —Ç—Ä–µ–∫–∞—Ç—å –∏—Ö ID. –¢–æ–ª—å–∫–æ —á–∏—Å—Ç–∏—Ç—å –æ—á–µ—Ä–µ–¥–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ. –ü–æ—Å–ª–µ –ø–∞—Ç—á–∞ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ –≥–æ–ª–æ—Å–æ–º –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç—Å—è.

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –º–æ–≥—É —Å—Ä–∞–∑—É —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π **diff-–ø–∞—Ç—á** –¥–ª—è —Ç–≤–æ–∏—Ö —Ñ–∞–π–ª–æ–≤ (`stasis_handler_optimized.py`, `ari_client.py`, `parallel_tts.py`, `filler_tts.py`), —á—Ç–æ–±—ã —Ç—ã –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–º–µ–Ω–∏–ª –µ–≥–æ –∏ –ø—Ä–æ–≤–µ—Ä–∏–ª.
____
___
___

**–í–æ–ø—Ä–æ—Å:** ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ diff-–ø–∞—Ç—á–∏, —á—Ç–æ–±—ã: (1) —Ñ–∏–ª–ª–µ—Ä—ã —Ä–µ–∞–ª—å–Ω–æ –∑–≤—É—á–∞–ª–∏; (2) barge-in —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–µ—Ä—ã–≤–∞–ª –æ–∑–≤—É—á–∏–≤–∞–Ω–∏–µ¬ª.

–î–µ–ª–∞—é –∫–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ —à–∞–≥–∞–º.

1. **–ï–¥–∏–Ω—ã–π –ø—É—Ç—å –∑–≤—É–∫–æ–≤** ‚Üí –≤—Å—ë –∫–ª–∞–¥—ë–º –≤ `/usr/share/asterisk/sounds/ru` –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º —á–µ—Ä–µ–∑ `sound:ru/<name>`. (–í –ª–æ–≥–∞—Ö –∏ –≤ —Ç–≤–æ–∏—Ö –∑–∞–º–µ—Ç–∫–∞—Ö –≤–∏–¥–Ω–æ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –ø—É—Ç–µ–π/—è–∑—ã–∫–∞, –∏–∑-–∑–∞ —á–µ–≥–æ —Ñ–∏–ª–ª–µ—Ä ¬´–∏–≥—Ä–∞–µ—Ç –≤ –ø—É—Å—Ç–æ—Ç—É¬ª.)
2. **–ù–∞—Å—Ç–æ—è—â–∏–π barge-in** ‚Üí –ø—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–æ–º –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–∏ –Ω–µ —Ç–æ–ª—å–∫–æ —á–∏—Å—Ç–∏–º –æ—á–µ—Ä–µ–¥–∏ TTS, –Ω–æ –∏ **–≥–∞—Å–∏–º –∞–∫—Ç–∏–≤–Ω—ã–µ ARI-playback‚Äô–∏** –∑–∞–ø—Ä–æ—Å–æ–º `DELETE /playbacks/{id}` + —Ç—Ä–µ–∫–∞–µ–º –∏—Ö ID.

–ù–∏–∂–µ –≥–æ—Ç–æ–≤—ã–µ –ø–∞—Ç—á–∏ (—Ñ–æ—Ä–º–∞—Ç unified diff). –ü—Ä–∏–º–µ–Ω—è–π –ø–æ –æ–¥–Ω–æ–º—É (–∏–ª–∏ —Å–æ–±–µ—Ä–∏ –≤ –æ–±—â–∏–π `.patch` –∏ –∑–∞–ø—É—Å—Ç–∏ `git apply`).

---

### 1) `tts_service.py` ‚Äî —É–Ω–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –∫–∞—Ç–∞–ª–æ–≥ –∑–≤—É–∫–æ–≤ Asterisk

```diff
--- a/tts_service.py
+++ b/tts_service.py
@@
 class TTSService:
     def __init__(self):
         self.api_key = os.getenv("OPENAI_API_KEY")
@@
-        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—É—Ç—å Asterisk –¥–ª—è –∑–≤—É–∫–æ–≤
-        self.asterisk_sounds_dir = "/var/lib/asterisk/sounds/ru"
+        # –ï–î–ò–ù–´–ô –ø—É—Ç—å, –∫–∞–∫ –∏ —É gRPC-TTS (–≤–∞–∂–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è)
+        # Debian/Ubuntu: /usr/share/asterisk/sounds/ru
+        # (—Ä–∞–Ω–µ–µ –±—ã–ª /var/lib/... ‚Üí –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ ¬´–Ω–µ–º—ã–º¬ª –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è–º)
+        self.asterisk_sounds_dir = "/usr/share/asterisk/sounds/ru"
```

---

### 2) `ari_client.py` ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∞–ª—å–Ω—É—é –æ—Å—Ç–∞–Ω–æ–≤–∫—É –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

```diff
--- a/ari_client.py
+++ b/ari_client.py
@@
 class AsteriskARIClient:
@@
     async def play_sound(self, channel_id: str, media_uri: str) -> str:
         """
         –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –∑–≤—É–∫ –Ω–∞ –∫–∞–Ω–∞–ª–µ. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç playback_id.
         """
         # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
         return playback_id
+
+    async def stop_playback(self, playback_id: str) -> bool:
+        """
+        –ñ—ë—Å—Ç–∫–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ (barge-in).
+        DELETE /playbacks/{playbackId}
+        """
+        url = f"{self.base_url}/playbacks/{playback_id}"
+        async with self.session.delete(url, auth=self.auth, timeout=self.timeout) as resp:
+            return resp.status in (200, 204)
```

> –ï—Å–ª–∏ —É —Ç–µ–±—è –º–µ—Ç–æ–¥ `play_sound` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ `playback_id`, –∞ –æ–±—ä–µ–∫—Ç ‚Äî –≤–µ—Ä–Ω–∏ –∏–º–µ–Ω–Ω–æ —Å—Ç—Ä–æ–∫–æ–≤—ã–π ID (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–∞–≤–∫–∞ –≤–Ω—É—Ç—Ä–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –º–µ—Ç–æ–¥–∞).

---

### 3) `stasis_handler_optimized.py` ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ–º –±–∞—Ä—å–µ—Ä—ã –∏ –ø—É—Ç—å –¥–ª—è —Ñ–∏–ª–ª–µ—Ä–æ–≤, —Ç—Ä–µ–∫–∞–µ–º playbacks

```diff
--- a/stasis_handler_optimized.py
+++ b/stasis_handler_optimized.py
@@
 import os, asyncio, logging, time, json
+import pwd, grp
 from typing import Dict, Any
@@
 class StasisHandlerOptimized:
     def __init__(self, ari, parallel_tts, filler_tts, asr, agent, log_store):
         self.ari = ari
         self.parallel_tts = parallel_tts
         self.filler_tts = filler_tts
@@
         self.active_calls: Dict[str, Dict[str, Any]] = {}
+        # –¢—Ä–µ–∫–∏–Ω–≥ –≤—Å–µ—Ö ARI-–ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–π –¥–ª—è –∂—ë—Å—Ç–∫–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏ barge-in
+        self.playback_events: Dict[str, Dict[str, Any]] = {}  # playback_id -> {channel_id, finished: bool}
@@
     async def on_event(self, event: Dict[str, Any]):
         et = event.get("type")
         # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ...
+        if et == "PlaybackStarted":
+            pid = event.get("playback", {}).get("id")
+            ch  = event.get("playback", {}).get("target_uri", "").split(":")[-1] or event.get("channel", {}).get("id")
+            if pid:
+                self.playback_events[pid] = {"channel_id": ch, "finished": False}
+                call = self.active_calls.setdefault(ch, {})
+                call["current_playback"] = pid
+                self.active_calls[ch] = call
+                self.logger.info(f"[ARI] PlaybackStarted id={pid} ch={ch}")
+        elif et == "PlaybackFinished":
+            pid = event.get("playback", {}).get("id")
+            ch  = event.get("playback", {}).get("target_uri", "").split(":")[-1] or event.get("channel", {}).get("id")
+            if pid and pid in self.playback_events:
+                self.playback_events[pid]["finished"] = True
+                self.logger.info(f"[ARI] PlaybackFinished id={pid} ch={ch}")
+                if ch in self.active_calls and self.active_calls[ch].get("current_playback") == pid:
+                    self.active_calls[ch]["current_playback"] = None
@@
-    async def stop_tts_on_barge_in_optimized(self, channel_id: str, event_name: str):
-        # –±—ã–ª–æ: —á–∏—Å—Ç–∏–ª–∏ –æ—á–µ—Ä–µ–¥–∏, –Ω–æ –Ω–µ –≥–∞—Å–∏–ª–∏ —Ä–µ–∞–ª—å–Ω–æ–µ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ
-        if self.parallel_tts:
-            await self.parallel_tts.clear_all_queues(channel_id)
-        self.logger.info("Barge-in: queues cleared, ready for new input")
+    async def stop_tts_on_barge_in_optimized(self, channel_id: str, event_name: str):
+        """
+        –†–µ–∞–ª—å–Ω—ã–π barge-in: –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –í–°–ï –∞–∫—Ç–∏–≤–Ω—ã–µ ARI-–ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è + —á–∏—Å—Ç–∏–º –æ—á–µ—Ä–µ–¥–∏.
+        """
+        self.logger.info(f"üö´ [OPTIMIZED BARGE-IN] {event_name} ‚Üí stop all playbacks & queues (ch={channel_id})")
+        call = self.active_calls.get(channel_id, {})
+        # 1) –¢–µ–∫—É—â–∏–π playback
+        current = call.get("current_playback")
+        if current:
+            try:
+                ok = await self.ari.stop_playback(current)
+                if ok:
+                    self.logger.info(f"üõë Stopped current playback: {current}")
+            except Exception as e:
+                self.logger.error(f"‚ùå Failed to stop playback {current}: {e}")
+            finally:
+                call["current_playback"] = None
+                self.active_calls[channel_id] = call
+        # 2) –í—Å–µ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ playbacks, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –≤–∏–¥–∏–º –ø–æ —Å–æ–±—ã—Ç–∏—è–º
+        active_for_channel = [pid for pid, meta in self.playback_events.items()
+                              if meta.get("channel_id") == channel_id and not meta.get("finished", True)]
+        for pid in active_for_channel:
+            try:
+                ok = await self.ari.stop_playback(pid)
+                if ok:
+                    self.logger.info(f"üõë Force stopped playback: {pid}")
+            except Exception as e:
+                self.logger.warning(f"‚ö†Ô∏è Could not stop playback {pid}: {e}")
+            finally:
+                self.playback_events[pid]["finished"] = True
+        # 3) –ì–∞—Å–∏–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ TTS
+        if self.parallel_tts:
+            await self.parallel_tts.clear_all_queues(channel_id)
+        # 4) –§–ª–∞–≥–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
+        call["user_interrupted"] = True
+        call["is_speaking"] = False
+        self.active_calls[channel_id] = call
+        self.logger.info("‚úÖ Barge-in completed ‚Äî ready for new input")
+
+    async def play_instant_filler(self, channel_id: str, filler_text: str) -> None:
+        """
+        –ï–î–ò–ù–´–ô —Å–ø–æ—Å–æ–± –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è —Ñ–∏–ª–ª–µ—Ä–∞:
+        - —Å–æ—Ö—Ä–∞–Ω—è–µ–º WAV –≤ /usr/share/asterisk/sounds/ru
+        - –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∫–∞–∫ sound:ru/<name>
+        """
+        audio: bytes = await self.filler_tts.get_instant_filler(filler_text)
+        ts = int(time.time() * 1000)
+        out_dir = "/usr/share/asterisk/sounds/ru"
+        os.makedirs(out_dir, exist_ok=True)
+        fname = f"filler_{channel_id}_{ts}.wav"
+        fpath = os.path.join(out_dir, fname)
+        with open(fpath, "wb") as f:
+            f.write(audio)
+        # –î–æ—Å—Ç—É–ø Asterisk‚Äô—É
+        try:
+            uid = pwd.getpwnam("asterisk").pw_uid
+            gid = grp.getgrnam("asterisk").gr_gid
+            os.chown(fpath, uid, gid)
+        except Exception:
+            pass
+        os.chmod(fpath, 0o644)
+        # –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
+        name_no_ext = os.path.splitext(fname)[0]
+        media_uri = f"sound:ru/{name_no_ext}"
+        playback_id = await self.ari.play_sound(channel_id, media_uri)
+        if playback_id:
+            self.playback_events[playback_id] = {"channel_id": channel_id, "finished": False}
+            call = self.active_calls.setdefault(channel_id, {})
+            call["current_playback"] = playback_id
+            self.active_calls[channel_id] = call
+            self.logger.info(f"üéß Filler playback started: {playback_id}")
```

---

### 4) `parallel_tts.py` ‚Äî —Ç—Ä–µ–∫–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è –∏ –≥–∞—Å–∏–º –∏—Ö –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –æ—á–µ—Ä–µ–¥–µ–π

```diff
--- a/parallel_tts.py
+++ b/parallel_tts.py
@@
 from collections import defaultdict, deque
@@
 class ParallelTTSProcessor:
     def __init__(self, ari_client, logger, *args, **kwargs):
         self.ari = ari_client
         self.logger = logger
@@
+        # channel_id -> set(playback_id). –ù—É–∂–Ω–æ –¥–ª—è barge-in.
+        self.active_playbacks = defaultdict(set)
@@
     async def play_chunk(self, channel_id: str, chunk_basename_no_ext: str):
         """
         –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π WAV-—á–∞–Ω–∫ (–ª–µ–∂–∏—Ç –≤ /usr/share/asterisk/sounds/ru).
         """
-        playback_id = await self.ari.play_sound(channel_id, f"sound:{chunk_basename_no_ext}")
+        # –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º —Ä—É—Å—Å–∫—É—é –¥–æ—Ä–æ–∂–∫—É
+        playback_id = await self.ari.play_sound(channel_id, f"sound:ru/{chunk_basename_no_ext}")
         if playback_id:
             self.logger.info(f"üéµ Chunk playback started: {playback_id}")
+            self.active_playbacks[channel_id].add(playback_id)
         return playback_id
@@
     def on_playback_finished(self, channel_id: str, playback_id: str):
-        # –±—ã–ª–æ: —Ç–æ–ª—å–∫–æ –ª–æ–≥
+        # —É–±–∏—Ä–∞–µ–º –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö
+        if channel_id in self.active_playbacks:
+            self.active_playbacks[channel_id].discard(playback_id)
+        # –ª–æ–≥ –æ—Å—Ç–∞–≤–ª—è–µ–º
         self.logger.info(f"üèÅ Chunk playback finished: {playback_id}")
@@
     async def clear_all_queues(self, channel_id: str):
         """
-        –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤–æ—Ä–∫–µ—Ä—ã –∏ –æ—á–∏—â–∞–µ—Ç –æ—á–µ—Ä–µ–¥–∏.
+        –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤–æ—Ä–∫–µ—Ä—ã, –æ—á–∏—â–∞–µ—Ç –æ—á–µ—Ä–µ–¥–∏ –∏ –ñ–Å–°–¢–ö–û –≥–∞—Å–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è –Ω–∞ –∫–∞–Ω–∞–ª–µ.
         """
         # ... —Ç–≤–æ–π –∫–æ–¥ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–æ—Ä–∫–µ—Ä–æ–≤/–æ—á–µ—Ä–µ–¥–µ–π ...
+        # –ñ—ë—Å—Ç–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö playbacks
+        for pid in list(self.active_playbacks.get(channel_id, set())):
+            try:
+                ok = await self.ari.stop_playback(pid)
+                if ok:
+                    self.logger.info(f"üõë Stopped active playback: {pid}")
+            except Exception as e:
+                self.logger.warning(f"‚ö†Ô∏è stop_playback failed for {pid}: {e}")
+        self.active_playbacks[channel_id].clear()
```

> –ï—Å–ª–∏ —É —Ç–µ–±—è —Å–æ–±—ã—Ç–∏–µ `PlaybackFinished` –ª–æ–≤–∏—Ç—Å—è –≤ `stasis_handler_optimized.py`, –ø—Ä–æ—Å—Ç–æ –Ω–µ –∑–∞–±—É–¥—å –æ—Ç—Ç—É–¥–∞ –≤—ã–∑—ã–≤–∞—Ç—å `parallel_tts.on_playback_finished(channel_id, playback_id)` ‚Äî —Ç–∞–∫ –∫–∞—Ä—Ç—ã –±—É–¥—É—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã.

---

### 5) `filler_tts.py` ‚Äî –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä—É–µ–º ¬´–ø—É—Å—Ç—ã–µ¬ª —Ñ–∞–π–ª—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è API)

```diff
--- a/filler_tts.py
+++ b/filler_tts.py
@@
 class FillerTTS:
     async def get_instant_filler(self, text: str) -> bytes:
         audio: bytes = await self._synthesize(text)  # —Ç–≤–æ–π –º–µ—Ç–æ–¥ —Å–∏–Ω—Ç–µ–∑–∞
+        self.logger.info(f"üìè Filler audio size: {len(audio)} bytes for '{text}'")
+        if len(audio) < 1000:
+            self.logger.warning(f"‚ö†Ô∏è Suspicious small filler: {len(audio)} bytes; check sample rate and path")
         return audio
```

---

## –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –ø–æ—Å–ª–µ –ø–∞—Ç—á–µ–π

1. –ó–≤–æ–Ω–∏ ‚Üí –¥–æ–∂–¥–∏—Å—å –∞–≤—Ç–æ-—Ñ–∏–ª–ª–µ—Ä–∞ ‚Üí **–¥–æ–ª–∂–µ–Ω —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ–∑–≤—É—á–∞—Ç—å**; –≤ –ª–æ–≥–∞—Ö —É–≤–∏–¥–∏—à—å –ø—É—Ç—å `/usr/share/asterisk/sounds/ru/...` –∏ `üéß Filler playback started ...`. 
2. –í–æ –≤—Ä–µ–º—è —Ä–µ—á–∏ –±–æ—Ç–∞ —Å–∫–∞–∂–∏ ¬´—Å—Ç–æ–ø¬ª/¬´–ø–æ–¥–æ–∂–¥–∏¬ª ‚Üí –≤ –ª–æ–≥–∞—Ö —É–≤–∏–¥–∏—à—å `üõë Stopped current playback ...` –∏ **–∑–≤—É–∫ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–æ—Ä–≤—ë—Ç—Å—è**. 

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî —Å–æ–±–µ—Ä—É –≤—Å—ë –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª `fix-bargein-and-fillers.patch` –ø–æ–¥ `git apply`.
